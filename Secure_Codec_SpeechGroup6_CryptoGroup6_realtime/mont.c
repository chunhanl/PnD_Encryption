/*#########################################################################
#  P & D Embedded Systems and Multimedia [H09M0a]
#  En/Decryption
#  
#  Chun Han Lu
#  Yi Hsuan Li
#########################################################################*/
#include<stdio.h>
#include "mont.h"


size32_t n[SIZE]={
    0xC0CC3997,0x9DF80794,0x6161FDFD,0xB47D1AF4,0x7C3FDBB4,0x676DE0F0,0xA4B11193,0x5E006AF8,0x44950C26,0x1E310081,0x2C5B67D0,0x0CF2F890,0xFF0C811F,0x0829B713,0xB830626C,
    0xF0B867ED,0xA018F2D2,0x688C5671,0xF0165B3A,0x831C0E92,0x0E5B2352,0xC9E17001,0xB4E1A4F8,0xC968BE6A,0x78A81BD2,0xB6ABD083,0x99BCEFE1,0xF7C2A749,0x7F19436D,0x9B2062AA,
    0xC3F85F9A,0x08CB7EDF,0x374932E9,0x5D5C542D,0x8031C41F,0xE3230B4F,0x89944A61,0xB1D4ABF9,0xD905C404,0x40F3955E,0x7C0A8D66,0x1D0CB4EE,0x18C685E5,0x1A49BB96,0x8861CFD8,
    0x44DBBDED,0x388D4F06,0x38C947AA,0xBE677ADF,0x1C873980,0x8750D1E4,0x12F30FC8,0x77ED29B0,0x7FA2B583,0x0BF54A68,0xAED44773,0x5E05D8D5,0x45739200,0x3A639500,0x81127240,
    0x1617CFF1,0xE37FA897,0x9F924FAA,0x91BC9105};

size32_t nprime[SIZE] = {
    0xE0E629D9,0xF9AC1018,0x04F809EA,0xEE3F9CB0,0x0D9DF156,0xEC016D5A,0xD56F2DC4,0xB2F078A2,0xFA804F00,0xEFB6865B,0x2DCAC76E,0x432C4A75,0x81C3D29B,0x707DA315,0x1E9AD262,
    0x24BDC8F7,0xCD768097,0x395A83A1,0x51AED275,0x3D01EFD7,0xCC0112D1,0x500232D8,0xDA78FB82,0x5651599B,0x0BC6FA6C,0x2CAF06EB,0x24DFA4B3,0x0DD56FF6,0xDBD7898C,0x13F5EBD4,
    0x4DFC3485,0x213DD184,0x85DF0539,0xB8F861D7,0xFC03E906,0x89911B95,0xE02F003D,0x6914A4FE,0x0C61B83C,0x1FAAF63F,0x3C01F167,0xF7CD2566,0xAAC8BA71,0xF0E13B71,0x97A33B23,
    0xC62164F6,0x2F326F4B,0xF30929DF,0xC09A3B10,0x961FF6C3,0xCBD63DED,0x032E2B46,0x49603DB6,0x3BE4F9A0,0xB7D5FF88,0x32F6AE6B,0xBD007360,0x5A48FF1E,0xC94C546E,0xEA360CC8,
    0x52A47628,0xD6305E24,0xAFCD3EA5,0xAA53FBC9};


size32_t rmodn[SIZE]={
    0x3F33C669,0x6207F86B,0x9E9E0202,0x4B82E50B,0x83C0244B,0x98921F0F,0x5B4EEE6C,0xA1FF9507,0xBB6AF3D9,0xE1CEFF7E,0xD3A4982F,0xF30D076F,0x00F37EE0,0xF7D648EC,0x47CF9D93,
    0x0F479812,0x5FE70D2D,0x9773A98E,0x0FE9A4C5,0x7CE3F16D,0xF1A4DCAD,0x361E8FFE,0x4B1E5B07,0x36974195,0x8757E42D,0x49542F7C,0x6643101E,0x083D58B6,0x80E6BC92,0x64DF9D55,
    0x3C07A065,0xF7348120,0xC8B6CD16,0xA2A3ABD2,0x7FCE3BE0,0x1CDCF4B0,0x766BB59E,0x4E2B5406,0x26FA3BFB,0xBF0C6AA1,0x83F57299,0xE2F34B11,0xE7397A1A,0xE5B64469,0x779E3027,
    0xBB244212,0xC772B0F9,0xC736B855,0x41988520,0xE378C67F,0x78AF2E1B,0xED0CF037,0x8812D64F,0x805D4A7C,0xF40AB597,0x512BB88C,0xA1FA272A,0xBA8C6DFF,0xC59C6AFF,0x7EED8DBF,
    0xE9E8300E,0x1C805768,0x606DB055,0x6E436EFA};
size32_t r2modn[SIZE]={
    0x9C4F757D,0x8253CD7B,0x39D3993E,0x1E495D1E,0x603F9E03,0x7FEF0786,0x9B1C0A8E,0xC70C5991,0xECDC9FEC,0xCD776C8A,0xC395EE43,0xC8AD9641,0xADA675FF,0x7D8A51DB,0x8D1B3FE5,
    0xFC933D10,0x39C5959C,0x1F158B22,0xF55D0DB2,0xF017B22E,0x5ABC2B10,0xD0C517D1,0xBE91980F,0xAF0F2A36,0x6E284B4C,0xD32C585F,0x2E109487,0x5889565F,0x78D7FA03,0xF58737E3,
    0x61BFAABC,0x57AA4477,0xC906F674,0xE165CCF4,0xA87CD107,0xBC33FCB6,0xC2E334CA,0x67FB6453,0x71380969,0x7858E497,0xFCD11EC5,0xDFE57B4A,0x07BF7572,0x51026390,0x711BB094,
    0xAD712CFF,0x241FE6D3,0x6DE7F771,0x73A30DFD,0x5829B2E9,0xEB5E9BBE,0xF262DC8E,0x4F13CA01,0xC1A4371B,0x412E6E57,0xFAE7FA1E,0x96752968,0xBECFE120,0xEF9BB86A,0x96F0EA2A,
    0x8E9473D5,0x77869EB3,0xC2A987B1,0x5372FB70};

size32_t one[SIZE]= {
    0x00000001,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,
    0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,
    0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,
    0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,
    0x00000000,0x00000000,0x00000000,0x00000000};
//-----





void mp_print(const size32_t *res){
    printf("\n");
    int i;
    for(i=0;i<SIZE;i++){
        printf("%08X",res[SIZE-i-1]);
    }
    printf("\n");
}


void print32(const size32_t res){
    printf("\n");
    printf("%08X",res);
    printf("\n");
}
void print64(const size64_t res){
    printf("\n");
    printf("%08X%08X",(size32_t)(res>>32),(size32_t)res);
    printf("\n");
}

void mont( size32_t *c,const  size32_t *a,const  size32_t *b){

		size32_t m[SIZE]={0x00000000};


	    size32_t t0 =0;
	    size32_t t1 =0;
	    size32_t t2 =0;

	    size64_t s0 =0;
	    size64_t s1 =0;




	    size64_t tmp   =0;
	    size64_t tmp_2 =0;
	    size64_t tmp_3 =0;

	    size32_t n0 = n[0];
	    size32_t np0 = nprime[0];

	    s_size16_t signed_i =0;
	    s_size64_t signed_c =0;
	    s_size64_t signed_tmp =0;

	    size32_t S =0;
	    size32_t m_tmp =0;

	    size8_t i =0;
	    size8_t j =0;
	    size8_t k =0;
	    size8_t I =0;


	    for(i=0;i<SIZE;i++){
	        k =i;
	        for(j=0;j<i;j++){
	            tmp= t0+_mpy32u(a[j],b[k]);   //t0+_mpy32u(a[j],b[k])
	            //===ADD==== ADD(t,1,C,SIZE_T);
	            tmp_2 = t1+(tmp>>32);
	            t1= tmp_2;
	            t2 = _sadd(t2,(tmp_2>>32));
	            //==========


	            tmp_3=(tmp&0xFFFFFFFF)+_mpy32u(m[j],n[k]);
	            t0=tmp_3;


	            //===ADD==== ADD(t,1,C,SIZE_T);
	            tmp_2 = t1+(tmp_3>>32);
	            t1=tmp_2;
	            t2 =_sadd( t2 ,(tmp_2>>32));
	            //==========
	            k--;

	        }

	        tmp=t0+_mpy32u(a[i],b[0]);
	        S=tmp;
	        //===ADD==== ADD(t,1,C,SIZE_T);
	        tmp_2 = t1+(tmp>>32);
	        t1=tmp_2;
	        t2 =_sadd( t2 ,(tmp_2>>32));


	        //========================================

	        //m[i] =S*nprime[0];
	        //tmp=S+m[i]*n[0];
	        m_tmp= _mpy32u(S,np0);
	        tmp=S+_mpy32u(m_tmp,n0);
	        m[i]=m_tmp;

	        S=tmp;
	        //===ADD==== ADD(t,1,C,SIZE_T);
	        tmp_2 = t1+(tmp>>32);
	        t1=tmp_2;
	        t2 = _sadd( t2 ,(tmp_2>>32));
	        //========================================

	        t0=t1;
	        t1=t2;
	        t2=0;


	    }


	    s0=SIZE+SIZE;
	    s1=SIZE-1;

	    for(I=SIZE;I<s0;I++){

	        for(j=I-s1;j<SIZE;j++){
	            k= I-j;
	            tmp= t0+_mpy32u(a[j],b[k]);
	            //===ADD==== ADD(t,1,C,SIZE_T);
	            tmp_2 = t1+(tmp>>32);
	            t1=tmp_2;
	            t2 =_sadd( t2 ,(tmp_2>>32));
	            //========================================



	            tmp_3=(tmp&0xFFFFFFFF)+_mpy32u(m[j],n[k]);
	            t0=tmp_3;
	            //===ADD==== ADD(t,1,C,SIZE_T);
	            tmp_2 = t1+(tmp_3>>32);
	            t1=tmp_2;
	            t2 = _sadd( t2 ,(tmp_2>>32));
	            //========================================

	        }

	        m[I-SIZE]=t0;
	        t0=t1;
	        t1=t2;
	        t2=0;

	    }

	     for(signed_i=SIZE-1;signed_i!=0;signed_i--){
	    	 if(m[signed_i]<n[signed_i]){
	    		 break;
	    	 }
	    	 else if(m[signed_i]>n[signed_i]){
	    		 //Subtraction
	    		 signed_tmp = 0;
	    		 signed_c=0;
	    		 for(i=0;i<=(SIZE-1);i++){
	    			 signed_tmp =(size64_t)m[i]-(size64_t)n[i]+signed_c;
	    			 m[i] = signed_tmp;
	    			 if(signed_tmp>=0)signed_c=0;
	    			 else signed_c=-1;
	    		 }
	    		 break;
	    	 }
	     }


	    for(i=0;i<SIZE;i++)c[i]=m[i];

}


void mont_exp( size32_t *cipher,const size32_t *message,const size32_t *e,const int EbitNum){

    size32_t xbar[SIZE]={0x00000000};

    size32_t A[SIZE]= {0x00000000};

    size32_t arrayCt=0;
    size32_t flag=0;

    mont(xbar,message,r2modn);
    int i;
    for(i=0;i<SIZE;i++)A[i]=rmodn[i];



    for(i=EbitNum;i!=0;i--){
        mont(A,A,A);

        arrayCt = e[(i-1)/32];
        flag = (arrayCt>>((i-1)%32))&0x01; //8= 1byte

        if(flag){
            mont(A,A,xbar);
        }

        //printf("MontExp Progressing [ %1f %% ]\r",((float)i/(float)EbitNum)*100);

        //printf("\n%d flag:%d ",i,flag!=0);mp_print(A);
    }


    mont(A,A,one);
    for(i=0;i<SIZE;i++)cipher[i]=A[i];
}




//16 bit Version
/*size16_t n[SIZE]={
    0x3997,0xC0CC,0x0794,0x9DF8,0xFDFD,0x6161,0x1AF4,0xB47D,0xDBB4,0x7C3F,0xE0F0,0x676D,0x1193,0xA4B1,0x6AF8,0x5E00,0x0C26,0x4495,0x0081,0x1E31,0x67D0,0x2C5B,0xF890,
    0x0CF2,0x811F,0xFF0C,0xB713,0x0829,0x626C,0xB830,0x67ED,0xF0B8,0xF2D2,0xA018,0x5671,0x688C,0x5B3A,0xF016,0x0E92,0x831C,0x2352,0x0E5B,0x7001,0xC9E1,0xA4F8,0xB4E1,
    0xBE6A,0xC968,0x1BD2,0x78A8,0xD083,0xB6AB,0xEFE1,0x99BC,0xA749,0xF7C2,0x436D,0x7F19,0x62AA,0x9B20,0x5F9A,0xC3F8,0x7EDF,0x08CB,0x32E9,0x3749,0x542D,0x5D5C,0xC41F,
    0x8031,0x0B4F,0xE323,0x4A61,0x8994,0xABF9,0xB1D4,0xC404,0xD905,0x955E,0x40F3,0x8D66,0x7C0A,0xB4EE,0x1D0C,0x85E5,0x18C6,0xBB96,0x1A49,0xCFD8,0x8861,0xBDED,0x44DB,
    0x4F06,0x388D,0x47AA,0x38C9,0x7ADF,0xBE67,0x3980,0x1C87,0xD1E4,0x8750,0x0FC8,0x12F3,0x29B0,0x77ED,0xB583,0x7FA2,0x4A68,0x0BF5,0x4773,0xAED4,0xD8D5,0x5E05,0x9200,
    0x4573,0x9500,0x3A63,0x7240,0x8112,0xCFF1,0x1617,0xA897,0xE37F,0x4FAA,0x9F92,0x9105,0x91BC};

size16_t nprime[SIZE] = {
    0x29D9,0xE0E6,0x1018,0xF9AC,0x09EA,0x04F8,0x9CB0,0xEE3F,0xF156,0x0D9D,0x6D5A,0xEC01,0x2DC4,0xD56F,0x78A2,0xB2F0,0x4F00,0xFA80,0x865B,0xEFB6,0xC76E,0x2DCA,0x4A75,
    0x432C,0xD29B,0x81C3,0xA315,0x707D,0xD262,0x1E9A,0xC8F7,0x24BD,0x8097,0xCD76,0x83A1,0x395A,0xD275,0x51AE,0xEFD7,0x3D01,0x12D1,0xCC01,0x32D8,0x5002,0xFB82,0xDA78,
    0x599B,0x5651,0xFA6C,0x0BC6,0x06EB,0x2CAF,0xA4B3,0x24DF,0x6FF6,0x0DD5,0x898C,0xDBD7,0xEBD4,0x13F5,0x3485,0x4DFC,0xD184,0x213D,0x0539,0x85DF,0x61D7,0xB8F8,0xE906,
    0xFC03,0x1B95,0x8991,0x003D,0xE02F,0xA4FE,0x6914,0xB83C,0x0C61,0xF63F,0x1FAA,0xF167,0x3C01,0x2566,0xF7CD,0xBA71,0xAAC8,0x3B71,0xF0E1,0x3B23,0x97A3,0x64F6,0xC621,
    0x6F4B,0x2F32,0x29DF,0xF309,0x3B10,0xC09A,0xF6C3,0x961F,0x3DED,0xCBD6,0x2B46,0x032E,0x3DB6,0x4960,0xF9A0,0x3BE4,0xFF88,0xB7D5,0xAE6B,0x32F6,0x7360,0xBD00,0xFF1E,
    0x5A48,0x546E,0xC94C,0x0CC8,0xEA36,0x7628,0x52A4,0x5E24,0xD630,0x3EA5,0xAFCD,0xFBC9,0xAA53};


size16_t rmodn[SIZE]={
    0xC669,0x3F33,0xF86B,0x6207,0x0202,0x9E9E,0xE50B,0x4B82,0x244B,0x83C0,0x1F0F,0x9892,0xEE6C,0x5B4E,0x9507,0xA1FF,0xF3D9,0xBB6A,0xFF7E,0xE1CE,0x982F,0xD3A4,0x076F,
    0xF30D,0x7EE0,0x00F3,0x48EC,0xF7D6,0x9D93,0x47CF,0x9812,0x0F47,0x0D2D,0x5FE7,0xA98E,0x9773,0xA4C5,0x0FE9,0xF16D,0x7CE3,0xDCAD,0xF1A4,0x8FFE,0x361E,0x5B07,0x4B1E,
    0x4195,0x3697,0xE42D,0x8757,0x2F7C,0x4954,0x101E,0x6643,0x58B6,0x083D,0xBC92,0x80E6,0x9D55,0x64DF,0xA065,0x3C07,0x8120,0xF734,0xCD16,0xC8B6,0xABD2,0xA2A3,0x3BE0,
    0x7FCE,0xF4B0,0x1CDC,0xB59E,0x766B,0x5406,0x4E2B,0x3BFB,0x26FA,0x6AA1,0xBF0C,0x7299,0x83F5,0x4B11,0xE2F3,0x7A1A,0xE739,0x4469,0xE5B6,0x3027,0x779E,0x4212,0xBB24,
    0xB0F9,0xC772,0xB855,0xC736,0x8520,0x4198,0xC67F,0xE378,0x2E1B,0x78AF,0xF037,0xED0C,0xD64F,0x8812,0x4A7C,0x805D,0xB597,0xF40A,0xB88C,0x512B,0x272A,0xA1FA,0x6DFF,
    0xBA8C,0x6AFF,0xC59C,0x8DBF,0x7EED,0x300E,0xE9E8,0x5768,0x1C80,0xB055,0x606D,0x6EFA,0x6E43};

size16_t r2modn[SIZE]={
    0x757D,0x9C4F,0xCD7B,0x8253,0x993E,0x39D3,0x5D1E,0x1E49,0x9E03,0x603F,0x0786,0x7FEF,0x0A8E,0x9B1C,0x5991,0xC70C,0x9FEC,0xECDC,0x6C8A,0xCD77,0xEE43,0xC395,0x9641,
    0xC8AD,0x75FF,0xADA6,0x51DB,0x7D8A,0x3FE5,0x8D1B,0x3D10,0xFC93,0x959C,0x39C5,0x8B22,0x1F15,0x0DB2,0xF55D,0xB22E,0xF017,0x2B10,0x5ABC,0x17D1,0xD0C5,0x980F,0xBE91,
    0x2A36,0xAF0F,0x4B4C,0x6E28,0x585F,0xD32C,0x9487,0x2E10,0x565F,0x5889,0xFA03,0x78D7,0x37E3,0xF587,0xAABC,0x61BF,0x4477,0x57AA,0xF674,0xC906,0xCCF4,0xE165,0xD107,
    0xA87C,0xFCB6,0xBC33,0x34CA,0xC2E3,0x6453,0x67FB,0x0969,0x7138,0xE497,0x7858,0x1EC5,0xFCD1,0x7B4A,0xDFE5,0x7572,0x07BF,0x6390,0x5102,0xB094,0x711B,0x2CFF,0xAD71,
    0xE6D3,0x241F,0xF771,0x6DE7,0x0DFD,0x73A3,0xB2E9,0x5829,0x9BBE,0xEB5E,0xDC8E,0xF262,0xCA01,0x4F13,0x371B,0xC1A4,0x6E57,0x412E,0xFA1E,0xFAE7,0x2968,0x9675,0xE120,
    0xBECF,0xB86A,0xEF9B,0xEA2A,0x96F0,0x73D5,0x8E94,0x9EB3,0x7786,0x87B1,0xC2A9,0xFB70,0x5372};

size16_t one[SIZE]= {
    0x0001,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
    0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
    0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
    0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
    0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
    0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000};*/
